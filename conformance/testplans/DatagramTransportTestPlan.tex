\documentclass[11pt]{article}
\usepackage{geometry}                % See geometry.pdf to learn the layout options. There are lots.
\geometry{letterpaper}                   % ... or a4paper or a5paper or ... 
%\geometry{landscape}                % Activate for for rotated page geometry
\usepackage[parfill]{parskip}    % Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{epstopdf}
\usepackage{hyperref}

\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}

\title{OpenLCB Test plan for the Datagram Transport Protocol}
\author{The OpenLCB Group}
%\date{}                                         % Activate to display a given date or no date

\begin{document}
\maketitle


\section{Introduction}

This note documents the procedure for testing an OpenLCB implementation against the 
\href{https://nbviewer.org/github/openlcb/documents/blob/master/standards/DatagramTransportS.pdf}{Datagram Transport Standard}.

The tests are traceable to specific sections of the Standard.

The testing assumes that the Device Under Test (DUT) is being exercised by other
nodes on the message network, 
e.g. is responding to enquiries from other parts of the message network.

\subsection{Required Equipment}

See the separate ``Installing the OpenLCB Test Software" document for initial installation 
and set up of the test program.

If a direct CAN connection will be used,
a supported USB-CAN adapter
    \footnote{See ``Installing the OpenLCB Test Software"}
is required. 
Connect the adapter to the DUT using a single UTP cable and connect two CAN terminators.

Provide power to the DUT using its recommended method.

\section{Set Up}
The following steps need to be done once to configure the test program:.
\begin{enumerate}
\item Start the test configuration program. 
\item Select ``Set Up DUT".
\item Get the Node ID from the DUT\footnote{Where do we require this to be marked on a node?} 
\item Enter that Node ID into the program.
\item Configure the test program for the USB-CAN adapter's device address
        or the TCP hostname and port.
\item Quit the test program and reply ``Y" to "Save configuration?" when prompted.
\end{enumerate}

The following steps need to be done at the start of each testing session.
\begin{enumerate}
\item Check that the DUT is ready for operation.
\item Start the test program.
\end{enumerate}

\section{Datagram Transport Procedure}

Select ``Datagram testing" in the test program, 
then select each section below in turn.  Follow the prompts
for when to check outputs against the node documentation.

Note that this process is unable to test datagrams from the DUT to the tester.
There is no standard way to elicit those.  They will be tested as part of the 
Memory Configuration Protocol testing, if applicable.

A node which does not self-identify in PIP that it supports
datagram transfer will be deemed to have passed these tests.

\subsection{Datagram Reception}

This tests the messages in Standard sections 4.1 and 4.2 or 4.3, 
including the error code constraints in Standard section 4.3.1
\footnote{This section references the Message Transport Standard, 
section 3.5.5}
and the interactions in sections 6.1 or 6.2.

The tester will send a datagram to the DUT. The DUT in turn will 
either accept the datagram (sections 4.2 and 6.1) or 
reject it (sections 4.3 and 6.2). Either response is acceptable.

This section's tests cover:

\begin{enumerate}
\item If the datagram is accepted,
    \begin{enumerate}
    \item That the Datagram OK message is received,
    \item That the Datagram OK message has proper source and destination node IDs, 
    \item that the Datagram OK message contains exactly 1 byte of flags,
    \item that the 0x70 bits of the flags are zeros.
    \end{enumerate}
\item if the datagram is rejected, 
    \begin{enumerate}
    \item That the Datagram Rejected message is received,
    \item That the Datagram Rejected message has proper source and destination node IDs, 
    \item that the Datagram Rejected message contains at least two bytes of error code,
    \item that the 0xF000 bits of the error code are either 0x1000 or 0x2000,
    \item that the 0x0F00 bits of the error code are zeros.
    \end{enumerate}
\end{enumerate}

This process is repeated for datagrams of length 1, 10 and 72 bytes to exercise the full
range of datagram framing.


\end{document}  
